# logbook.log with extra data keys will raise an error in the log which is faster by far than waiting for the logbook to load in the UI

script:

  covers_ensure_state:
    sequence:
      - service: logbook.log
        data_template: { name: "", message: "", errormessage: "*** COVERS_ENSURE_STATE for cover {{ state_attr(cover_id, 'friendly_name') }} ({{ cover_id }}) *** Started, target_lift: {{ target_lift }}, target_tilt: {{ target_tilt }} ***" }
      - service: script.covers_ensure_state_tilt
        data_template:
          cover_id: "{{ cover_id }}"
          target_tilt: "{{ target_tilt }}"
      - service: script.covers_ensure_state_lift
        data_template:
          cover_id: "{{ cover_id }}"
          target_lift: "{{ target_lift }}"

  covers_ensure_state_lift:
    sequence:
      - service: logbook.log
        data_template: { name: "", message: "", errormessage: "*** COVERS_ENSURE_STATE_LIFT for cover {{ state_attr(cover_id, 'friendly_name') }} ({{ cover_id }}) *** Started, is_lift: {{ state_attr(cover_id, 'current_position') }}, target_lift: {{ target_lift }} ***" }
      - condition: template
        value_template: "{{ state_attr(cover_id, 'current_position') != 'unknown' and state_attr(cover_id, 'current_position') != 0 }}"
      - service: logbook.log
        data_template: { name: "", message: "", errormessage: "*** COVERS_ENSURE_STATE_LIFT for cover {{ state_attr(cover_id, 'friendly_name') }} ({{ cover_id }}) *** Diff: {{ ((state_attr(cover_id, 'current_position') - (target_lift | int)) | abs) }} ***" }
      - condition: template
        value_template: "{{ ((state_attr(cover_id, 'current_position') - (target_lift | int)) | abs) > 3 }}"
      - service: logbook.log
        data_template: { name: "", message: "", errormessage: "*** COVERS_ENSURE_STATE_LIFT for cover {{ state_attr(cover_id, 'friendly_name') }} ({{ cover_id }}) *** Setting lift position from {{ state_attr(cover_id, 'current_position') }} to {{ target_lift }} ***" }
      - service: cover.set_cover_position
        data_template:
          entity_id: "{{ cover_id }}"
          position: "{{ target_lift }}"
      - delay: '00:00:05'

  covers_ensure_state_tilt:
    sequence:
      - service: logbook.log
        data_template: { name: "", message: "", errormessage: "*** COVERS_ENSURE_STATE_TILT for cover {{ state_attr(cover_id, 'friendly_name') }} ({{ cover_id }}) *** Started, is_lift: {{ state_attr(cover_id, 'current_position') }}, is_tilt: {{ state_attr(cover_id, 'current_tilt_position') }}, target_tilt: {{ target_tilt }} ***" }
      - condition: template
        value_template: "{{ state_attr(cover_id, 'current_tilt_position') != 'unknown' and state_attr(cover_id, 'current_position') != 0 }}"
      - service: logbook.log
        data_template: { name: "", message: "", errormessage: "*** COVERS_ENSURE_STATE_TILT for cover {{ state_attr(cover_id, 'friendly_name') }} ({{ cover_id }}) *** Diff: {{ ((state_attr(cover_id, 'current_tilt_position') - (target_tilt | int)) | abs) }} ***" }
      - condition: template
        value_template: "{{ ((state_attr(cover_id, 'current_tilt_position') - (target_tilt | int)) | abs) > 3 }}"
      - service: logbook.log
        data_template: { name: "", message: "", errormessage: "*** COVERS_ENSURE_STATE_TILT for cover {{ state_attr(cover_id, 'friendly_name') }} ({{ cover_id }}) *** Setting tilt position from {{ state_attr(cover_id, 'current_tilt_position') }} to {{ target_tilt }} ***" }
      - service: cover.set_cover_tilt_position
        data_template:
          entity_id: "{{ cover_id }}"
          tilt_position: "{{ target_tilt }}"
      - delay: '00:00:05'
